name: Deploy to Droplet

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan 137.184.190.88 >> ~/.ssh/known_hosts

      - name: Deploy code via rsync
        run: |
          rsync -avz --delete ./ root@137.184.190.88:/root/trading-bot \
            --exclude='.git' \
            --exclude='venv' \
            --exclude='.github'

      - name: Run secure Docker container
        run: |
          ssh root@137.184.190.88 << 'EOF'
            cd /root/trading-bot

            # Stop and remove old container if it exists
            docker stop trading-bot || true
            docker rm trading-bot || true

            # Build the Docker image
            docker build -t trading-bot .

            # Run hardened container with injected secrets
            docker run -d \
              --restart always \
              --name trading-bot \
              --read-only \
              --cap-drop ALL \
              --user botuser \
              -e ALPACA_PAPER_ACCOUNT_KEY_ID=${{ secrets.ALPACA_PAPER_ACCOUNT_KEY_ID }} \
              -e ALPACA_PAPER_ACCOUNT_SECRET_KEY=${{ secrets.ALPACA_PAPER_ACCOUNT_SECRET_KEY }} \
              trading-bot
          EOF