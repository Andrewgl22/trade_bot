name: Deploy to Droplet

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan 167.172.194.125 >> ~/.ssh/known_hosts

      - name: Rsync code to droplet
        run: |
          rsync -avz --delete ./ root@167.172.194.125:/root/trading-bot \
            --exclude='.git' --exclude='venv' --exclude='.github'

      - name: Build Docker image on droplet
        run: |
          ssh root@167.172.194.125 "cd /root/trading-bot && docker build -t trading-bot ."

      - name: Run Alembic migrations (ephemeral container)
        run: |
          ssh root@167.172.194.125 "cd /root/trading-bot && docker run --rm --network host -e DATABASE_URL='${{ secrets.DATABASE_URL }}' trading-bot alembic upgrade head"

      - name: Run app container
        run: |
          ssh root@167.172.194.125 "\
            cd /root/trading-bot && \
            docker stop trading-bot || true && \
            docker rm trading-bot || true && \
            docker system prune -af && \
            rm -rf /run/docker/runtime-runc/* && \
            docker run -d --restart always --name trading-bot \
              --network host \
              --read-only --cap-drop ALL --user botuser \
              -v ~/trade_logs:/logs:rw \
              -e ALPACA_PAPER_ACCOUNT_KEY_ID='${{ secrets.ALPACA_PAPER_ACCOUNT_KEY_ID }}' \
              -e ALPACA_PAPER_ACCOUNT_SECRET_KEY='${{ secrets.ALPACA_PAPER_ACCOUNT_SECRET_KEY }}' \
              -e DATABASE_URL='${{ secrets.DATABASE_URL }}' \
              trading-bot"
