name: Deploy to Droplet

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan 167.172.194.125 >> ~/.ssh/known_hosts

      - name: Deploy code via rsync
        run: |
          rsync -avz --delete ./ root@167.172.194.125:/root/trading-bot \
            --exclude='.git' \
            --exclude='venv' \
            --exclude='.github'

      - name: Run secure Docker container
        env:
          ALPACA_PAPER_ACCOUNT_KEY_ID: ${{ secrets.ALPACA_PAPER_ACCOUNT_KEY_ID }}
          ALPACA_PAPER_ACCOUNT_SECRET_KEY: ${{ secrets.ALPACA_PAPER_ACCOUNT_SECRET_KEY }}
        run: |
          ssh root@167.172.194.125 "
            export ALPACA_PAPER_ACCOUNT_KEY_ID=$ALPACA_PAPER_ACCOUNT_KEY_ID
            export ALPACA_PAPER_ACCOUNT_SECRET_KEY=$ALPACA_PAPER_ACCOUNT_SECRET_KEY

            cd /root/trading-bot

            docker stop trading-bot || true
            docker rm trading-bot || true

            docker system prune -af
            rm -rf /run/docker/runtime-runc/*

            docker build -t trading-bot .

            echo \"Running: docker run -d --name trading-bot ... trading-bot\"
            echo \"ALPACA_PAPER_ACCOUNT_KEY_ID=\$ALPACA_PAPER_ACCOUNT_KEY_ID\"
            echo \"ALPACA_PAPER_ACCOUNT_SECRET_KEY=\$ALPACA_PAPER_ACCOUNT_SECRET_KEY\"

            docker run -d --restart always --name trading-bot \
              --read-only --cap-drop ALL --user botuser \
              -v ~/trade_logs:/logs:rw \
              -e \"ALPACA_PAPER_ACCOUNT_KEY_ID=\$ALPACA_PAPER_ACCOUNT_KEY_ID\" \
              -e \"ALPACA_PAPER_ACCOUNT_SECRET_KEY=\$ALPACA_PAPER_ACCOUNT_SECRET_KEY\" \
              trading-bot
          "


